{% extends '../baseuser.html' %}

{% load static %}

{% block title %}健康グラフ{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/kenkougurahu/healthgraph.css' %}">
<h2>健康グラフ</h2>

<div class="selection">
    <label for="user-select">家族選択:</label>
    <select id="user-select">
        {% for member in family_members %}
            <option value="{{ member.family_id|default:member.user_id }}">
                {{ member.name }}
                {% if member.user_id %}
                    {{ member.family_name }}
                {% endif %}
            </option>
        {% endfor %}
    </select>

    <label for="start-date">月選択:</label>
    <input type="month" id="start-date">
    
    <button id="display-button">表示</button>
</div>

<canvas id="weightChart" width="400" height="200"></canvas>

{% endblock %}

{% block scripts %}
<script>
    // グラフのデータを更新する関数
    function displayGraph() {
        console.log("displayGraph関数が呼ばれました");

        const selectedUser = document.getElementById('user-select').value;
        const startDate = document.getElementById('start-date').value;

        if (!startDate) {
            alert("月を選択してください。");
            return;
        }

        // POSTリクエストで体重データを取得する
        fetch('/cook/health_graph/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',  // CSRFトークン
            },
            body: JSON.stringify({
                family_id: selectedUser,
                start_date: startDate,
            }),
        })
        .then(response => response.json())
        .then(data => {
            console.log("データ受信:", data);

            if (data.error) {
                alert(data.error);
                return;
            }

            const dates = data.dates;
            const weights = data.weights;

            if (window.weightChart) {
                window.weightChart.destroy();
            }

            const ctx = document.getElementById('weightChart').getContext('2d');
            window.weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '体重推移',
                        data: weights,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '日付'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '体重 (kg)'
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error("fetchエラー:", error);
            alert("データ取得に失敗しました");
        });
    }

    // ボタンがクリックされたときの処理
    const displayButton = document.getElementById('display-button');
    if (displayButton) {
        displayButton.addEventListener('click', function() {
            console.log("表示ボタンがクリックされました");
            displayGraph(); // 表示ボタンがクリックされたらグラフを更新
        });
    } else {
        console.error("display-buttonが見つかりません");
    }
</script>
{% endblock %}
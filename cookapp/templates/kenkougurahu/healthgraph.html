{% extends '../baseuser.html' %}

{% load static %}

{% block title %}健康グラフ{% endblock %}

{% block content %}
<h2>健康グラフ</h2>

<div class="selection">
    <label for="user-select">家族選択:</label>
    <select id="user-select">
        {% for member in family_members %}
            <option value="{{ member.family_id|default:member.user_id }}">
                {% if member.user_id %}
                    {{ member.name }} (自分)
                {% else %}
                    {{ member.family_name }}
                {% endif %}
            </option>
        {% endfor %}
    </select>

    <label for="start-date">日付選択:</label>
    <input type="date" id="start-date">
    <button onclick="displayGraph()">表示</button>
</div>

<!-- エラーメッセージを表示するための要素 -->
<div id="error-message" style="color: red; display: none;"></div>

<canvas id="weightChart" width="400" height="200"></canvas>

{% endblock %}

<script>
    let weightChart; // グローバル変数でグラフインスタンスを保持

    function displayGraph() {
        const selectedUser = document.getElementById('user-select').value;
        const startDate = document.getElementById('start-date').value;

        // エラーメッセージを非表示にする
        document.getElementById('error-message').style.display = 'none';

        if (!startDate) {
            // 日付が選択されていない場合、エラーメッセージを表示
            document.getElementById('error-message').innerText = "日付を選択してください。";
            document.getElementById('error-message').style.display = 'block';
            return;
        }

        // POSTリクエストで体重データを取得
        fetch('/health_graph/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}', // CSRFトークンを送信
            },
            body: JSON.stringify({
                family_id: selectedUser,
                start_date: startDate,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                // サーバー側でエラーが発生した場合、エラーメッセージを表示
                document.getElementById('error-message').innerText = data.error;
                document.getElementById('error-message').style.display = 'block';
                return;
            }

            const dates = data.dates;
            const weights = data.weights;

            // 既存のグラフがあれば破棄して新しく生成
            if (weightChart) {
                weightChart.destroy();
            }

            // グラフを表示
            const ctx = document.getElementById('weightChart').getContext('2d');
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: `体重推移`,
                        data: weights,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '日付'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '体重 (kg)'
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            // JavaScriptでのエラーをキャッチした場合もエラーメッセージを表示
            console.error("エラーが発生しました:", error);
            document.getElementById('error-message').innerText = "データの取得に失敗しました。";
            document.getElementById('error-message').style.display = 'block';
        });
    }
</script>
</html>